<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="shortcut icon"
      href="https://horans.github.io/asset/favicon.ico"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      aside {
        z-index: 3;
      }
      .transition {
        transition: all ease 0.3s;
      }
      .cursor-pointer,
      .form-check input,
      .form-check label {
        cursor: pointer;
      }
      nav.transition:not(.enabled) {
        opacity: 0;
        pointer-events: none;
      }
      .list-inline {
        font-size: 0.75rem;
      }
      .toast {
        width: 6rem;
      }
    </style>
    <title>Random String Generator</title>
  </head>
  <body>
    <!--
    /*****************************************************
    *  project: random string generator                  *
    *  description: simple online password generator     *
    *  author: horans@gmail.com                          *
    *  url: https://github.com/horans/random             *
    *  update: 210331                                    *
    *****************************************************/
    -->
    <header class="my-4">
      <h1 class="text-center">Random String Generator</h1>
    </header>
    <main class="position-relative" id="random">
      <aside
        class="position-absolute bg-white w-100 h-100"
        :class="{ invisible : init }"
      ></aside>
      <form class="container">
        <div class="input-group mb-3">
          <button
            class="btn btn-outline-primary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            name="shortcut"
          >
            Length: {{ option.length.current }}
          </button>
          <ul class="dropdown-menu">
            <li v-for="i in option.length.shortcut" :key="i">
              <button
                class="dropdown-item"
                :class="{ active: i == option.length.current }"
                :name="'length-' + i"
                @click.prevent="option.length.current = i"
              >
                {{ i }}
              </button>
            </li>
          </ul>
          <input
            type="range"
            class="form-control form-range px-2 h-auto"
            :min="option.length.min"
            :max="option.length.max"
            name="length"
            v-model="option.length.current"
          />
          <button
            class="btn btn-primary"
            type="button"
            name="generate"
            @click="debouncedRepeat"
          >
            Generate
          </button>
        </div>
        <nav>
          <div
            class="form-check form-switch form-check-inline transition"
            data-bs-toggle="tooltip"
            v-for="(v, k) in option.character"
            :key="k"
            :title="v.label"
            :class="{ 'bg-light': k === 'symbol' && v.enabled }"
          >
            <input
              class="form-check-input"
              type="checkbox"
              name="character"
              :id="'character-' + k"
              v-model="v.enabled"
            />
            <label class="form-check-label" :for="'character-' + k"
              >{{ d.startCase(k) }}</label
            >
          </div>
        </nav>
        <nav
          class="bg-light transition"
          :class="{ enabled: option.character.symbol.enabled }"
        >
          <div
            class="form-check form-check-inline form-control-sm"
            data-bs-toggle="tooltip"
            v-for="(v, k) in option.character.symbol.case"
            :key="k"
            :title="d.startCase(k)"
          >
            <input
              class="form-check-input"
              type="checkbox"
              name="symbol"
              :id="'symbol-' + k"
              v-model="v.enabled"
            />
            <label class="form-check-label" :for="'symbol-' + k"
              >{{ v.label }}</label
            >
          </div>
        </nav>
        <div class="input-group input-group-lg mt-2">
          <output
            class="form-control text-center font-monospace cursor-pointer user-select-all"
            name="result"
            @click="debouncedCopy(result)"
          >
            {{ result }}
          </output>
        </div>
        <ul
          class="list-inline mt-5 text-center text-black-50 font-monospace"
          v-if="history.length > 0"
        >
          <li
            class="list-inline-item cursor-pointer user-select-all"
            v-for="(i, n) in history"
            :key="n"
            :id="'history-' + n"
            @click="debouncedCopy(i)"
          >
            {{ i }}
          </li>
        </ul>
      </form>
    </main>
    <footer>
      <div class="position-fixed top-0 end-0 p-3" style="z-index: 5">
        <div
          id="liveToast"
          class="toast hide"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-body text-center">
            Copied!
          </div>
        </div>
      </div>
    </footer>

    <!-- <script src="https://unpkg.com/vue@next"></script> -->
    <script src="https://unpkg.com/vue@3.0.10/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      /* global Vue _ bootstrap */
      const rand = {
        data () {
          return {
            init: false,
            result: null,
            history: [],
            option: {
              length: {
                min: 4,
                max: 64,
                current: 16,
                shortcut: [4, 8, 16, 32, 64]
              },
              character: {
                number: { enabled: true, label: '0123456789' },
                upperCase: {
                  enabled: true,
                  label: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
                },
                lowerCase: {
                  enabled: true,
                  label: 'abcdefghijklmnopqrstuvwxyz'
                },
                symbol: {
                  enabled: false,
                  label: 'Special Characters',
                  case: {
                    period: { enabled: true, label: '.' },
                    plus: { enabled: true, label: '+' },
                    minus: { enabled: true, label: '-' },
                    asterisk: { enabled: true, label: '*' },
                    slash: { enabled: true, label: '/' },
                    hash: { enabled: true, label: '#' },
                    exclamation: { enabled: false, label: '!' },
                    questionMark: { enabled: false, label: '?' },
                    comma: { enabled: false, label: ',' },
                    underscore: { enabled: false, label: '_' },
                    atSign: { enabled: false, label: '@' },
                    dollarSign: { enabled: false, label: '$' },
                    ampersand: { enabled: false, label: '&' },
                    tilde: { enabled: false, label: '~' },
                    caret: { enabled: false, label: '^' },
                    verticalBar: { enabled: false, label: '|' },
                    parentheis: { false: false, label: '()' },
                    brace: { enabled: false, label: '{}' },
                    bracket: { enabled: false, label: '[]' }
                  }
                }
              },
              delay: 200,
              list: 3
            },
            appearance: {
              tooltip: {
                trigger: null,
                list: null
              },
              toast: null
            }
          }
        },
        computed: {
          // current length of string
          l () {
            return this.option.length.current
          },
          // use lodash in template
          // stackoverflow.com/questions/37694243
          d () {
            return _
          }
        },
        methods: {
          // render output
          render () {
            let output = new Array(0)
            // create character picking pool and fill in mandatory options
            let pool = ''
            _.each(this.option.character, (v, k) => {
              if (v.enabled && k !== 'symbol') {
                pool += v.label
                output.push(this.pick(v.label))
              }
            })
            let poolSymbol = ''
            if (this.option.character.symbol.enabled) {
              _.each(this.option.character.symbol.case, (v, k) => {
                if (v.enabled) poolSymbol += v.label
              })
              output.push(this.pick(poolSymbol))
            }
            pool += poolSymbol
            for (let i = 0; i < this.l - output.length; i++) {
              output.push(null)
            }
            output = _.shuffle(output)
            // fill in non-empty slots
            for (let i = 0; i < this.l; i++) {
              if (!output[i]) output[i] = this.pick(pool)
            }
            this.result = output.join('')
          },
          // random pick character from current pool
          pick (str) {
            return str.charAt(Math.floor(Math.random() * str.length))
          },
          // copy generated string and show toast
          copy (val) {
            navigator.clipboard.writeText(val)
            this.appearance.toast.show()
          },
          // fallback to first option when all are disabled
          fallback (list) {
            let s = false
            _.each(list, (v, k) => {
              if (v.enabled) {
                s = true
                return false
              }
            })
            if (!s) {
              this.$nextTick(() => {
                _.each(list, (v, k) => {
                  v.enabled = true
                  return false
                })
              })
            }
          },
          // generate more with same options
          repeat () {
            if (this.history.length === this.option.list) this.history.pop()
            this.history.unshift(this.result)
            this.render()
          }
        },
        watch: {
          // generate new output when character options are changed
          option: {
            handler (nv) {
              // fallback options
              this.fallback(this.option.character)
              if (nv.character.symbol.enabled) {
                this.fallback(this.option.character.symbol.case)
              }
              // reset history
              this.history = []
              // auto generate
              this.debouncedRender()
            },
            deep: true
          }
        },
        created () {
          // debounce the output
          this.debouncedRender = _.debounce(this.render, this.option.delay)
          // debounce the copying
          this.debouncedCopy = _.debounce(this.copy, this.option.delay)
          // debounce the repeating
          this.debouncedRepeat = _.debounce(this.repeat, this.option.delay)
        },
        mounted () {
          // initialize tooltip for character options
          // getbootstrap.com/docs/5.0/components/tooltips/
          this.appearance.tooltip.trigger = [].slice.call(
            document.querySelectorAll('[data-bs-toggle="tooltip"]')
          )
          this.appearance.tooltip.list = this.appearance.tooltip.trigger.map(
            el => {
              return new bootstrap.Tooltip(el, { trigger: 'hover' })
            }
          )
          // initialize toast for copy
          this.appearance.toast = new bootstrap.Toast(
            document.querySelectorAll('.toast')[0],
            { delay: this.option.delay * 10 }
          )
          // system ready
          this.init = true
          // default ouput
          this.render()
        }
      }
      Vue.createApp(rand).mount('#random')
    </script>
  </body>
</html>
